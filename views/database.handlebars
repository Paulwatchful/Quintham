<!DOCTYPE html>
<html>

<head>
    <title>Quintham Database Manager</title>
    <style>
        body {
            font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
            padding: 20px;
        }

        .toolbar {
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }

        .toolbar button {
            padding: 5px 10px;
            cursor: pointer;
        }

        #status {
            color: gray;
            margin-left: 10px;
        }

        #editor {
            display: none;
            margin-top: 10px;
        }

        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }

        #results {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #results th,
        #results td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #results th {
            background-color: #f2f2f2;
        }

        /* Modal File Browser */
        #fileBrowser {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        #browserContent {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            height: 500px;
            overflow: auto;
        }

        .fileItem {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .fileItem:hover {
            background-color: #ddd;
        }

        .dirItem {
            font-weight: bold;
            color: #000080;
        }

        .fileItem.file {
            color: #333;
        }
    </style>
    <!-- We might need to load sql.js from a CDN or local includes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
</head>

<body>
    <h2>Quintham Database Manager</h2>
    <div class="toolbar">
        <button onclick="window.history.back()"> &lt; Back </button>
        Path: <input type="text" id="dbPath"
            value="C:\Users\PaulGreenwood\AppData\Local\Packages\Watchful_9nnya97m1bay6\LocalCache\Local\Watchful\database.db3"
            style="width: 400px;">
        <button onclick="checkDatabase()">Check Exists</button>
        <button onclick="browseFiles()">Browse...</button>
        <button onclick="downloadDatabase()">Load Database</button>
        <button onclick="saveDatabase()">Save & Upload</button>
        <span id="status">Ready</span>
    </div>

    <div id="editor">
        <h3>Execute SQL</h3>
        <textarea id="sqlInput">SELECT * FROM sqlite_master WHERE type='table';</textarea>
        <button onclick="runQuery()">Run Query</button>
        <div id="queryStatus"></div>
        <table id="results"></table>
    </div>

    <!-- File Browser Modal -->
    <div id="fileBrowser">
        <div id="browserContent">
            <h3>Select Database File <button onclick="closeBrowser()" style="float:right;">X</button></h3>
            <div style="margin-bottom: 5px;">
                <button onclick="loadDirectory('C:\\')">Go to C:\</button>
                <button onclick="goUpDir()">Up Level</button>
                <button onclick="connectAgent()" title="Establish connection tunnel to agent">Connect to Agent</button>
            </div>
            <div>Current Path: <span id="browserPath"></span></div>
            <hr />
            <div id="fileList"></div>
        </div>
    </div>

    <script>
        var currentNodeId = null;
        try {
            if (window.opener && window.opener.parent && window.opener.parent.currentNode) {
                currentNodeId = window.opener.parent.currentNode._id;
            } else if (window.currentNodeId) {
                currentNodeId = window.currentNodeId;
            } else if (parent && parent.currentNode) {
                currentNodeId = parent.currentNode._id;
            }
        } catch (e) { console.log('Error getting node ID', e); }

        if (!currentNodeId) alert("Error: Could not determine Device Node ID. Close this window and try again.");

        var db = null;
        var dbBinary = null;
        var SQL = null;
        var reqTimeout = null;

        // Init SQL.js
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
        }).then(function (sql) {
            SQL = sql;
            document.getElementById('status').innerText = "SQL Engine Ready";
        });

        function setStatus(msg) { document.getElementById('status').innerText = msg; }

        function checkDatabase() {
            setStatus("Checking...");
            sendPluginCommand('checkDatabase', { path: document.getElementById('dbPath').value });
        }

        function downloadDatabase() {
            setStatus("Downloading...");
            sendPluginCommand('readDatabase', { path: document.getElementById('dbPath').value });
        }

        function saveDatabase() {
            if (!db) { alert("No database loaded"); return; }
            setStatus("Exporting...");
            var binaryArray = db.export();
            // Convert to Base64
            var binaryString = "";
            for (var i = 0; i < binaryArray.length; i++) {
                binaryString += String.fromCharCode(binaryArray[i]);
            }
            var b64 = btoa(binaryString);

            setStatus("Uploading...");
            sendPluginCommand('writeDatabase', {
                path: document.getElementById('dbPath').value,
                data: b64
            });
        }

        function runQuery() {
            if (!db) return;
            var sql = document.getElementById('sqlInput').value;
            try {
                var results = db.exec(sql);
                renderResults(results);
                document.getElementById('queryStatus').innerText = "Query executed successfully.";
            } catch (e) {
                document.getElementById('queryStatus').innerText = "Error: " + e.message;
            }
        }

        function renderResults(results) {
            var tbl = document.getElementById('results');
            tbl.innerHTML = "";
            if (!results || results.length == 0) return;

            var columns = results[0].columns;
            var values = results[0].values;

            var thead = tbl.createTHead();
            var row = thead.insertRow();
            columns.forEach(col => {
                var th = document.createElement("th");
                th.innerText = col;
                row.appendChild(th);
            });

            var tbody = tbl.createTBody();
            values.forEach(valRow => {
                var row = tbody.insertRow();
                valRow.forEach(val => {
                    var cell = row.insertCell();
                    cell.innerText = val;
                });
            });
        }

        function sendPluginCommand(action, data) {
            var cmd = {
                action: 'plugin',
                plugin: 'quintham',
                pluginaction: action,
                nodeId: currentNodeId,
                reqId: Date.now()
            };
            if (data) Object.assign(cmd, data);
            window.opener.parent.meshserver.send(cmd);
        }

        // --- Browsing Logic ---
        function browseFiles() {
            document.getElementById('fileBrowser').style.display = 'block';
            var currentPath = document.getElementById('dbPath').value;
            // If it looks like a file (ends in .something), strip the filename
            var dir = currentPath;
            if (currentPath.match(/\.[0-9a-z]+$/i)) {
                var lastSlash = Math.max(currentPath.lastIndexOf('\\'), currentPath.lastIndexOf('/'));
                if (lastSlash !== -1) dir = currentPath.substring(0, lastSlash);
            }
            if (!dir || dir.trim() === '') dir = "C:\\";
            loadDirectory(dir);
        }

        function closeBrowser() {
            document.getElementById('fileBrowser').style.display = 'none';
        }

        function goUpDir() {
            var currentPath = document.getElementById('browserPath').innerText;
            // Simple string manipulation for 'Up'
            // Handle trailing slash
            if (currentPath.endsWith('\\')) currentPath = currentPath.slice(0, -1);
            if (currentPath.endsWith('/')) currentPath = currentPath.slice(0, -1);

            var separator = currentPath.indexOf('/') !== -1 ? '/' : '\\';
            var lastIdx = currentPath.lastIndexOf(separator);
            if (lastIdx !== -1) {
                var newPath = currentPath.substring(0, lastIdx);
                if (newPath.endsWith(':')) newPath += separator; // handle C: -> C:\
                if (newPath == '') newPath = separator; // handle /usr -> /
                loadDirectory(newPath);
            } else {
                // Already at root or invalid? Try C:\
                loadDirectory('C:\\');
            }
        }

        function loadDirectory(path) {
            document.getElementById('browserPath').innerText = path;
            document.getElementById('fileList').innerText = "Loading...";
            if (reqTimeout) clearTimeout(reqTimeout);
            reqTimeout = setTimeout(function () {
                document.getElementById('fileList').innerText = "Error: Request Timed Out (Agent might be offline or busy path)";
            }, 30000);
            sendPluginCommand('listDirectory', { path: path });
        }

        sendPluginCommand('listDirectory', { path: path });
        }

        var connectInterval = null;
        var connectAttempts = 0;

        function connectAgent() {
            if (!currentNodeId) return;
            // Standard MeshCentral connect command
            window.opener.parent.meshserver.send({ action: 'msg', type: 'tunnel', nodeid: currentNodeId, Usage: 1 });

            var statusDiv = document.getElementById('fileList');
            statusDiv.innerText = "Initiating connection...";

            if (connectInterval) clearInterval(connectInterval);
            connectAttempts = 0;

            connectInterval = setInterval(function () {
                connectAttempts++;
                statusDiv.innerText = "Waiting for agent connection... (Attempt " + connectAttempts + "/15)";

                // Try to load the directory again
                var path = document.getElementById('browserPath').innerText || 'C:\\';
                sendPluginCommand('listDirectory', { path: path });

                if (connectAttempts >= 15) {
                    clearInterval(connectInterval);
                    statusDiv.innerText = "Connection timed out. Please try connecting manually in the Desktop tab.";
                }
            }, 2000); // Retry every 2 seconds
        }

        function selectFile(path) {
            document.getElementById('dbPath').value = path;
            closeBrowser();
        }

        // Listen for messages from Server
        if (window.opener && window.opener.parent.pluginHandler.quintham) {
            window.opener.parent.pluginHandler.quintham.databaseResponse = function (msg) {
                console.log("DB Response", msg);
                handleResponse(msg.event || msg);
            }
        }

        function handleResponse(msg) {
            if (reqTimeout) clearTimeout(reqTimeout);

            // If we are connecting and get a success or a specific error (not 'Agent not connected'), stop retrying
            if (msg.error) {
                if (msg.error === 'Agent not connected') {
                    // If we are actively trying to connect, ignore this specific error and keep waiting
                    if (connectInterval) return;
                } else {
                    // Real error, stop retry
                    if (connectInterval) clearInterval(connectInterval);
                }

                if (msg.type == 'directory') {
                    // Only overwrite text if we aren't in the middle of a connect loop (or if connection failed)
                    if (!connectInterval) document.getElementById('fileList').innerText = "Error: " + msg.error;
                    return;
                }
                setStatus("Error: " + msg.error);
                return;
            }

            // If we received valid data, connection is successful!
            if (connectInterval) {
                clearInterval(connectInterval);
                connectInterval = null;
            }
            if (msg.type == 'check') {
                setStatus(msg.data ? "Database Exists" : "Database Not Found");
            }
            if (msg.type == 'read') {
                setStatus("Database Downloaded. Loading...");
                try {
                    var binaryString = atob(msg.data);
                    var bytes = new Uint8Array(binaryString.length);
                    for (var i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    db = new SQL.Database(bytes);
                    document.getElementById('editor').style.display = 'block';
                    setStatus("Database Loaded (" + bytes.length + " bytes)");
                } catch (e) {
                    setStatus("Error loading DB: " + e.message);
                }
            }
            if (msg.type == 'write') {
                setStatus("Database Uploaded Successfully.");
            }
            if (msg.type == 'directory') {
                renderDirectory(msg.data.path, msg.data.files);
            }
        }

        function renderDirectory(dirPath, files) {
            var list = document.getElementById('fileList');
            list.innerHTML = '';

            files.forEach(f => {
                var div = document.createElement('div');
                div.className = 'fileItem ' + (f.type == 'dir' ? 'dirItem' : 'file');
                var icon = f.type == 'dir' ? '&#128193; ' : '&#128196; '; // Folder or File emoji
                div.innerHTML = icon + f.name;

                div.onclick = function () {
                    if (f.type == 'dir') {
                        loadDirectory(f.path);
                    } else {
                        selectFile(f.path);
                    }
                };
                list.appendChild(div);
            });
        }

    </script>
</body>

</html>