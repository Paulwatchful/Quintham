<!DOCTYPE html>
<html>

<head>
    <title>Quintham Database Manager</title>
    <style>
        body {
            font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
            padding: 20px;
        }

        .toolbar {
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }

        .toolbar button {
            padding: 5px 10px;
            cursor: pointer;
        }

        #status {
            color: gray;
            margin-left: 10px;
        }

        #editor {
            display: none;
            margin-top: 10px;
        }

        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }

        #results {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #results th,
        #results td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #results th {
            background-color: #f2f2f2;
        }
    </style>
    <!-- We might need to load sql.js from a CDN or local includes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
</head>

<body>
    <h2>Quintham Database Manager</h2>
    <div class="toolbar">
        Path: <input type="text" id="dbPath" value="C:\ProgramData\Quintham\data.db" style="width: 300px;">
        <button onclick="checkDatabase()">Check Exists</button>
        <button onclick="downloadDatabase()">Load Database</button>
        <button onclick="saveDatabase()">Save & Upload</button>
        <span id="status">Ready</span>
    </div>

    <div id="editor">
        <h3>Execute SQL</h3>
        <textarea id="sqlInput">SELECT * FROM sqlite_master WHERE type='table';</textarea>
        <button onclick="runQuery()">Run Query</button>
        <div id="queryStatus"></div>
        <table id="results"></table>
    </div>

    <script>
        var currentNodeId = window.currentNodeId || window.opener.currentNodeId; // Get from opener
        var db = null;
        var dbBinary = null;
        var SQL = null;

        // Init SQL.js
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}`
        }).then(function (sql) {
            SQL = sql;
            document.getElementById('status').innerText = "SQL Engine Ready";
        });

        function setStatus(msg) { document.getElementById('status').innerText = msg; }

        function checkDatabase() {
            setStatus("Checking...");
            sendPluginCommand('checkDatabase', { path: document.getElementById('dbPath').value });
        }

        function downloadDatabase() {
            setStatus("Downloading...");
            sendPluginCommand('readDatabase', { path: document.getElementById('dbPath').value });
        }

        function saveDatabase() {
            if (!db) { alert("No database loaded"); return; }
            setStatus("Exporting...");
            var binaryArray = db.export();
            // Convert to Base64
            var binaryString = "";
            for (var i = 0; i < binaryArray.length; i++) {
                binaryString += String.fromCharCode(binaryArray[i]);
            }
            var b64 = btoa(binaryString);

            setStatus("Uploading...");
            sendPluginCommand('writeDatabase', {
                path: document.getElementById('dbPath').value,
                data: b64
            });
        }

        function runQuery() {
            if (!db) return;
            var sql = document.getElementById('sqlInput').value;
            try {
                var results = db.exec(sql);
                renderResults(results);
                document.getElementById('queryStatus').innerText = "Query executed successfully.";
            } catch (e) {
                document.getElementById('queryStatus').innerText = "Error: " + e.message;
            }
        }

        function renderResults(results) {
            var tbl = document.getElementById('results');
            tbl.innerHTML = "";
            if (!results || results.length == 0) return;

            var columns = results[0].columns;
            var values = results[0].values;

            var thead = tbl.createTHead();
            var row = thead.insertRow();
            columns.forEach(col => {
                var th = document.createElement("th");
                th.innerText = col;
                row.appendChild(th);
            });

            var tbody = tbl.createTBody();
            values.forEach(valRow => {
                var row = tbody.insertRow();
                valRow.forEach(val => {
                    var cell = row.insertCell();
                    cell.innerText = val;
                });
            });
        }

        function sendPluginCommand(action, data) {
            var cmd = {
                action: 'plugin',
                plugin: 'quintham',
                pluginaction: action,
                nodeId: currentNodeId,
                reqId: Date.now()
            };
            if (data) Object.assign(cmd, data);
            window.opener.parent.meshserver.send(cmd);
        }

        // Listen for messages from Server (relayed via Opener -> this)
        // Actually, the opener receives the message in 'user.handlebars' logic (onDeviceRefreshEnd... wait)
        // The main view 'user.handlebars' is where the websocket is connected.
        // We need a way to pass the message from the main view to this popup.
        // We can hook window.opener.pluginHandler.quintham.databaseResponse

        // Setup listener in opener
        if (window.opener && window.opener.parent.pluginHandler.quintham) {
            window.opener.parent.pluginHandler.quintham.databaseResponse = function (msg) {
                console.log("DB Response", msg);
                handleResponse(msg);
            }
        }

        function handleResponse(msg) {
            if (msg.error) {
                setStatus("Error: " + msg.error);
                return;
            }
            if (msg.type == 'check') {
                setStatus(msg.data ? "Database Exists" : "Database Not Found");
            }
            if (msg.type == 'read') {
                setStatus("Database Downloaded. Loading...");
                try {
                    var binaryString = atob(msg.data);
                    var bytes = new Uint8Array(binaryString.length);
                    for (var i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    db = new SQL.Database(bytes);
                    document.getElementById('editor').style.display = 'block';
                    setStatus("Database Loaded (" + bytes.length + " bytes)");
                } catch (e) {
                    setStatus("Error loading DB: " + e.message);
                }
            }
            if (msg.type == 'write') {
                setStatus("Database Uploaded Successfully.");
            }
        }

    </script>
</body>

</html>